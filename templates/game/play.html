{% extends 'game/base.html' %}
{% load static %}
{% load number_filters %}

{% block title %}íˆ¬ìí•˜ê¸° - ìœ ë‹ˆì½˜ ë©”ì´ì»¤{% endblock %}

{% block content %}
<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p class="loading-text">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>
</div>

<div class="play-page">

    <!-- ìºë¦­í„° & ì•„ì´ë””ì–´ -->
    <div class="character-box">
        <div class="character-info">
            <div class="character-image">
                <img src="{% static 'images/characters/' %}{{ character.key }}.png" alt="{{ character.name }}">
            </div>
            <h2>{{ character.name }}</h2>
            <p class="character-concept">{{ character.concept }}</p>
        </div>
        
        <div class="idea-bubble">
            <h3>ğŸ’¡ {{ idea.title }}</h3>
            <p>{{ idea.description }}</p>
        </div>
    </div>

    <!-- íˆ¬ì í¼ -->
    <div class="invest-section">
        <!-- ê²Œì„ ìƒíƒœ í‘œì‹œ -->
        <div class="game-status">
            <div class="status-item">
                <span class="label">ğŸ’°ìë³¸ê¸ˆ</span>
                <span class="value">{{ session.current_capital|korean_currency }}</span>
            </div>
            <div class="status-item">
                <span class="label">ğŸ¯ë‚¨ì€ ê¸°íšŒ</span>
                <span class="value">{{ session.remaining_chances }}íšŒ</span>
            </div>
            <div class="status-item">
                <span class="label">ğŸŒì„±ê³µ í™•ë¥ </span>
                <span class="value {{ prob_class }}">{{ prob_text }}</span>
            </div>
        </div>
        <form method="POST" action="{% url 'game:invest' session_id=session.pk %}" onsubmit="showLoading()">
            {% csrf_token %}
            
            <div class="form-group">
                <label>íˆ¬ì ê¸ˆì•¡ (ë§Œì›)</label>
                <input type="number" name="amount" max="{{ session.current_capital }}" id="amount" value="2000" required>
                <style>
                input[type="number"]::-webkit-outer-spin-button,
                input[type="number"]::-webkit-inner-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }
                </style>
                <small>2000ë§Œì› ì´ìƒ í˜¹ì€ ì˜¬ì¸ë§Œ ê°€ëŠ¥</small>
            </div>            
            <div class="btn-group">
                <button type="submit" class="btn btn-primary" name="action" value="invest" onclick="return handleInvestRange(event)">ğŸ’¸íˆ¬ìí•˜ê¸°</button>
                
                {% if can_enchant %}
                <button type="submit" class="btn btn-up" name="action" value="enchant">ğŸ’¡ìë¬¸í•˜ê¸°</button>
                {% else %}
                <button type="button" class="btn btn-up" disabled title="{% if enchant_used %}ì´ë¯¸ ìë¬¸í•¨{% else %}ìë³¸ê¸ˆ ë¶€ì¡±{% endif %}">
                    {% if enchant_used %}âœ…ìë¬¸ ì™„ë£Œ{% else %}ğŸ’¡ìë¬¸í•˜ê¸°{% endif %}
                </button>
                {% endif %}
                
                <button type="button" class="btn btn-danger" onclick="setAllIn()">ğŸ”¥ì˜¬ì¸</button>
                <!-- 0130 -->
                {% if session.remaining_reroles > 0 %}
                    <a href="{% url 'game:pass' session_id=session.pk %}" class="btn btn-secondary" onclick="showLoading2()">
                        â­ï¸íŒ¨ìŠ¤ ({{ session.remaining_reroles }}/5)
                    </a>
                {% else %}
                    <button type="button" class="btn btn-secondary" disabled style="cursor: not-allowed; opacity: 0.6;">
                        âŒíŒ¨ìŠ¤ ê¸°íšŒ ì†Œì§„ (0/5)
                    </button>
                {% endif %}
                <!-- end of 0130 -->
            </div>
        </form>
        
        <script>
        // ========== ë³€ìˆ˜ ì •ì˜ ==========
        const amountInput = document.getElementById('amount');
        const helpText = document.querySelector('.form-group small');
        const userCapital = {{ session.current_capital }};

        // ========== íˆ¬ì ë²”ìœ„ ì²´í¬ ==========
        function handleInvestRange(event) {
            const min = Math.min(2000, userCapital);
            const currentVal = parseInt(amountInput.value) || 0;

            // ìµœì†Œ íˆ¬ìê¸ˆ ì²´í¬ (ì˜¬ì¸ ì œì™¸)
            if (currentVal < 2000 && currentVal !== userCapital) {
                alert("2000ë§Œì› ì´ìƒ í˜¹ì€ ì˜¬ì¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                amountInput.value = min;
                event.preventDefault();
                return false;
            }

            return true;
        }

        // ========== ì˜¬ì¸ ê¸°ëŠ¥ ==========
        function setAllIn() {
            amountInput.value = userCapital;
        }

        // ========== ì´ˆê¸° ì„¤ì • ==========
        const minVal = Math.min(2000, userCapital);
        amountInput.value = minVal;
        amountInput.min = minVal;
        
        // ========== ë¡œë”© ì˜¤ë²„ë ˆì´ ==========
        function showLoading() {
            const messages = [
                "ğŸƒ íˆ¬ìí•œ íšŒì‚¬ê°€ ì—´ì‹¬íˆ êµ´ëŸ¬ê°€ëŠ” ì¤‘...",
                "ğŸ’¼ ì°½ì—…ê°€ê°€ ì‚¬ì—… ì¤€ë¹„ ì¤‘...",
                "ğŸš€ ìŠ¤íƒ€íŠ¸ì—…ì´ ì„±ì¥í•˜ëŠ” ì¤‘...",
                "ğŸ”¨ íˆ¬ìê¸ˆìœ¼ë¡œ ì—´ì‹¬íˆ ì¼í•˜ëŠ” ì¤‘...",
                "ğŸ“ˆ ì‚¬ì—… ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            document.querySelector('.loading-text').textContent = randomMsg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function showLoading2() {
            const messages = [
                "ğŸƒ ë‹¤ìŒ ì°½ì—…ê°€ê°€ ë¯¸íŒ…ë£¸ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ì¤‘...",
                "ğŸ’¼ ë‹¤ìŒ ì°½ì—…ê°€ê°€ ì•„ì´ë””ì–´ ë°œí‘œì¤€ë¹„ ì¤‘...",
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            document.querySelector('.loading-text').textContent = randomMsg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        </script>
    </div>
</div>
{% endblock %}